<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trapped - Jeu d'évasion</title>
    <link rel="icon" type="image/png" href="favicon.png?v=2">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Écran d'enregistrement des joueurs -->
        <div v-if="screen === 'registration'" class="registration-screen">
            <div class="registration-header">
                <div>
                    <h1>🚪 Trapped</h1>
                    <p class="subtitle">Enregistrez les joueurs (3-8)</p>
                </div>
                <button @click="toggleHelp" class="btn-help-registration" title="Aide">
                    ?
                </button>
            </div>

            <button @click="showLoadGame = !showLoadGame" class="btn-load-game">
                {{ showLoadGame ? 'Nouvelle partie' : 'Reprendre une partie' }}
            </button>

            <!-- Liste des parties sauvegardées -->
            <div v-if="showLoadGame" class="saved-games-list">
                <h3>Parties sauvegardées</h3>
                <div v-if="savedGames.length === 0" class="no-games">Aucune partie sauvegardée</div>
                <div v-for="game in savedGames" :key="game.id" class="saved-game-item">
                    <div @click="loadGame(game.id)" class="saved-game-content">
                        <div class="saved-game-header">
                            <span class="saved-game-date">{{ formatDate(game.createdAt) }}</span>
                            <span :class="['saved-game-status', game.status]">{{ game.status === 'playing' ? 'En cours' : 'Terminée' }}</span>
                        </div>
                        <div class="saved-game-info">
                            <span>Tour {{ game.currentTurn }}/15</span>
                            <span>•</span>
                            <span>{{ game.playerCount }} joueur{{ game.playerCount > 1 ? 's' : '' }}</span>
                        </div>
                        <div class="saved-game-players">{{ game.playerNames }}</div>
                    </div>
                    <button @click.stop="deleteGame(game.id)" class="btn-delete-game" title="Supprimer">🗑️</button>
                </div>
            </div>

            <div v-if="!showLoadGame">
                <div class="game-settings">
                    <div class="setting-group">
                        <label>Difficulté</label>
                        <select v-model="difficulty">
                            <option value="easy">Facile (25 points)</option>
                            <option value="normal" selected>Normale (20 points)</option>
                            <option value="hard">Difficile (15 points)</option>
                        </select>
                    </div>

                    <div class="setting-group checkbox-group">
                        <label>
                            <input type="checkbox" v-model="freeRoomsEnabled">
                            Pièces gratuites possibles (10% de chance)
                        </label>
                    </div>
                </div>

                <div class="player-form">
                    <input
                        v-model="newPlayerName"
                        @keyup.enter="addPlayer"
                        type="text"
                        placeholder="Nom du joueur"
                        maxlength="20"
                    >
                    <button @click="openAvatarPicker" class="btn-avatar-picker" type="button">
                        <img v-if="tempAvatar" :src="`avatars/${tempGender}/${tempAvatar}`" class="temp-avatar-preview">
                        <span v-else>Choisir avatar</span>
                    </button>
                    <button @click="addPlayer" :disabled="!newPlayerName.trim() || !tempAvatar">
                        Ajouter
                    </button>
                </div>

                <div class="player-list">
                    <div v-for="(player, index) in players" :key="index" class="player-item">
                        <img :src="`avatars/${player.gender}/${player.avatar}`" class="player-avatar-mini" :alt="player.name">
                        <span>{{ player.name }}</span>
                        <button @click="removePlayer(index)" class="btn-remove">×</button>
                    </div>
                </div>

                <button
                    @click="startGame"
                    :disabled="players.length < 3"
                    class="btn-start"
                >
                    Démarrer la partie ({{ players.length }}/8)
                </button>

                <p v-if="error" class="error">{{ error }}</p>
            </div>
        </div>

        <!-- Écran de jeu -->
        <div v-if="screen === 'game'" class="game-screen">
            <game-board
                :game="game"
                :remaining-time="remainingTime"
                @open-door="openDoor"
                @choose-door="chooseDoor"
                @free-player="freePlayer"
                @stay-in-room="stayInRoom"
                @give-up="giveUp"
                @go-home="goHome"
                @toggle-help="toggleHelp"
            ></game-board>
        </div>

        <!-- Écran de fin -->
        <div v-if="screen === 'end'" class="end-screen">
            <h1>🎮 Partie terminée</h1>

            <div v-if="endData.reason === 'victory'" class="winners">
                <h2>🏁 Gagnants !</h2>
                <table class="winners-table">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Nom</th>
                            <th>Points</th>
                            <th>Bonheur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(winner, index) in endData.winners" :key="winner.id">
                            <td class="rank">{{ index + 1 }}</td>
                            <td class="name">{{ winner.name }}</td>
                            <td class="points">{{ winner.points }}</td>
                            <td class="happiness">{{ winner.happiness || 0 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-else class="defeat">
                <h2>💀 Défaite</h2>
                <p v-if="endData.reason === 'timeout'">Le temps est écoulé (15 tours)</p>
                <p v-if="endData.reason === 'all_dead'">Tous les joueurs sont morts</p>
            </div>

            <div v-if="endData.survivors && endData.survivors.length > 0" class="survivors">
                <h3>Survivants</h3>
                <div v-for="survivor in endData.survivors" :key="survivor.id">
                    {{ survivor.name }} - {{ survivor.points }} points
                </div>
            </div>

            <div v-if="endData.dead && endData.dead.length > 0" class="dead">
                <h3>💀 Morts</h3>
                <div v-for="dead in endData.dead" :key="dead.id" class="dead-item">
                    {{ dead.name }}
                </div>
            </div>

            <div class="end-screen-actions">
                <button @click="resetGame" class="btn-reset">Nouvelle partie</button>
                <button @click="goHome" class="btn-home-end">Menu principal</button>
            </div>
        </div>

        <!-- Modale de confirmation -->
        <div v-if="showModal" class="modal-overlay" @click="cancelModal">
            <div class="modal-content" @click.stop>
                <h2>{{ modalData.title }}</h2>
                <p>{{ modalData.message }}</p>
                <div class="modal-actions">
                    <button @click="cancelModal" class="btn-modal-cancel">{{ modalData.cancelText }}</button>
                    <button @click="confirmModal" class="btn-modal-confirm">{{ modalData.confirmText }}</button>
                </div>
            </div>
        </div>

        <!-- Modale d'aide -->
        <div v-if="showHelp" class="modal-overlay" @click="toggleHelp">
            <div class="modal-content modal-help" @click.stop>
                <button @click="toggleHelp" class="btn-close-modal">×</button>
                <h2>🚪 Comment jouer à Trapped</h2>

                <div class="help-section">
                    <h3>🎯 Objectif</h3>
                    <p><strong>Jeu collaboratif :</strong> Faire sortir un maximum de joueurs ! Tous les joueurs vivants doivent atteindre la salle de sortie avec au moins 1 point. En cas d'égalité, le joueur avec le plus de bonheur gagne.</p>
                </div>

                <div class="help-section">
                    <h3>⚙️ Déroulement</h3>
                    <ul>
                        <li><strong>Tour par tour :</strong> Vous avez 2 minutes par tour pour faire votre choix</li>
                        <li><strong>15 tours maximum</strong> pour sortir, sinon c'est perdu pour tout le monde</li>
                        <li>Choisissez une porte ou restez dans votre salle actuelle</li>
                        <li>Tous les joueurs jouent simultanément à chaque tour</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>🚪 Les portes et leur capacité</h3>
                    <ul>
                        <li><strong>Portes fermées :</strong> Coûtent 1 point à ouvrir (premier joueur à choisir)</li>
                        <li><strong>Portes ouvertes :</strong> Gratuites pour les suivants</li>
                        <li><strong>Capacité (le chiffre) :</strong> Indique combien de joueurs peuvent franchir cette porte <strong>pendant le tour actuel</strong></li>
                        <li>Si le nombre maximum de joueurs est atteint, la porte est pleine et plus personne ne peut la choisir</li>
                        <li><strong>Bonheur :</strong> Chaque porte donne ou enlève du bonheur (invisible jusqu'à l'ouverture)</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>💰 Points et salles</h3>
                    <ul>
                        <li>Chaque salle coûte des points pour y entrer (sauf la sortie)</li>
                        <li>Le coût est caché jusqu'à ce qu'un joueur visite la salle</li>
                        <li><strong>0 point = vous êtes mort !</strong></li>
                        <li>Certaines salles peuvent être gratuites (si activé)</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>😊 Le bonheur</h3>
                    <p>Si plusieurs joueurs atteignent la sortie, celui avec le <strong>plus de bonheur total</strong> gagne. Le bonheur est influencé par les portes que vous franchissez.</p>
                </div>

                <div class="help-section">
                    <h3>🎮 Actions possibles</h3>
                    <ul>
                        <li><strong>Choisir une porte :</strong> Cliquez sur votre badge puis sur une flèche directionnelle</li>
                        <li><strong>Rester ici :</strong> Cliquez sur votre badge puis sur le bouton central</li>
                        <li><strong>Libérer un joueur :</strong> Si vous êtes à la sortie, vous pouvez abandonner pour sauver quelqu'un de bloqué</li>
                        <li><strong>Abandonner :</strong> Si quelqu'un est déjà sorti, vous pouvez abandonner</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>📊 Niveaux de difficulté</h3>
                    <ul>
                        <li><strong>Facile :</strong> 25 points de départ</li>
                        <li><strong>Normal :</strong> 20 points de départ</li>
                        <li><strong>Difficile :</strong> 15 points de départ</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>🏁 Conditions de victoire</h3>
                    <ul>
                        <li>✅ Tous les joueurs vivants atteignent la sortie</li>
                        <li>❌ Défaite si le temps expire (15 tours) ou si tous les joueurs meurent</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modale de sélection d'avatar -->
        <div v-if="showAvatarPicker" class="modal-overlay" @click="showAvatarPicker = false">
            <div class="modal-content modal-avatar-picker" @click.stop>
                <button @click="showAvatarPicker = false" class="btn-close-modal">×</button>
                <h2>Choisis ton avatar</h2>

                <div class="avatar-gender-selector">
                    <button
                        @click="avatarPickerGender = 'male'"
                        :class="['btn-gender', {active: avatarPickerGender === 'male'}]">
                        👨 Homme
                    </button>
                    <button
                        @click="avatarPickerGender = 'female'"
                        :class="['btn-gender', {active: avatarPickerGender === 'female'}]">
                        👩 Femme
                    </button>
                </div>

                <div class="avatar-grid">
                    <div
                        v-for="i in getAvatarCount(avatarPickerGender)"
                        :key="i"
                        @click="selectAvatar(avatarPickerGender, i)"
                        class="avatar-option"
                        :class="{selected: isAvatarUsed(avatarPickerGender, i)}">
                        <img :src="`avatars/${avatarPickerGender}/${avatarPickerGender}_${String(i).padStart(2, '0')}.png`" :alt="`Avatar ${i}`">
                        <span v-if="isAvatarUsed(avatarPickerGender, i)" class="avatar-used-badge">✓</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup de perte de points -->
        <div v-if="showPointsLossPopup" class="points-loss-overlay">
            <div class="points-loss-popup">
                <h2>Fin du tour {{ pointsLossData?.turn }}</h2>
                <div class="players-points-grid">
                    <div v-for="player in pointsLossData?.players" :key="player.id" class="player-points-card">
                        <div class="player-avatar">
                            <span v-if="player.finalStatus === 'dead'" class="player-status-icon">💀</span>
                            <span v-else-if="player.finalStatus === 'winner'" class="player-status-icon">🏁</span>
                            <img v-else :src="`avatars/${player.gender}/${player.avatar}`" class="player-avatar-img" :alt="player.name">
                        </div>
                        <div class="player-name">{{ player.name }}</div>
                        <div class="player-points-value">
                            <span class="points-number">{{ player.animatedPoints }}</span>
                            <span class="points-label">pts</span>
                            <span v-if="player.showLoss && player.pointsLost > 0" class="points-lost-indicator">
                                -{{ player.pointsLost }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
