<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trapped - Jeu d'Ã©vasion</title>
    <link rel="icon" type="image/png" href="favicon.png?v=2">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/home.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Ã‰cran d'authentification -->
        <div v-if="screen === 'auth'" class="auth-screen">
            <div class="auth-container">
                <div class="logo-container">
                    <img src="assets/logo.png" alt="Trapped" class="game-logo">
                </div>

                <div class="auth-tabs">
                    <button @click="authMode = 'login'" :class="['auth-tab', {active: authMode === 'login'}]">Connexion</button>
                    <button @click="authMode = 'register'" :class="['auth-tab', {active: authMode === 'register'}]">Inscription</button>
                </div>

                <div v-if="authMode === 'login'" class="auth-form">
                    <input
                        v-model="authEmail"
                        @keyup.enter="login"
                        type="email"
                        placeholder="Email"
                        autocomplete="email">
                    <input
                        v-model="authPassword"
                        @keyup.enter="login"
                        type="password"
                        placeholder="Mot de passe"
                        autocomplete="current-password">
                    <button @click="login" class="btn-auth">Se connecter</button>
                </div>

                <div v-if="authMode === 'register'" class="auth-form">
                    <input
                        v-model="authUsername"
                        type="text"
                        placeholder="Nom d'utilisateur"
                        autocomplete="username">
                    <input
                        v-model="authEmail"
                        type="email"
                        placeholder="Email"
                        autocomplete="email">
                    <input
                        v-model="authPassword"
                        @keyup.enter="register"
                        type="password"
                        placeholder="Mot de passe (min 6 caractÃ¨res)"
                        autocomplete="new-password">
                    <button @click="register" class="btn-auth">S'inscrire</button>
                </div>

                <p v-if="error" class="error">{{ error }}</p>
            </div>
        </div>

        <!-- Ã‰cran d'accueil avec sidebar -->
        <div v-if="screen === 'registration'" class="home-screen">
            <!-- Bouton hamburger mobile -->
            <button @click="toggleMobileSidebar" :class="['hamburger-btn', { active: mobileMenuOpen }]">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <!-- Overlay pour fermer le menu -->
            <div @click="closeMobileSidebar" :class="['sidebar-overlay', { active: mobileMenuOpen }]"></div>

            <!-- Sidebar -->
            <div :class="['sidebar', { 'mobile-open': mobileMenuOpen }]">
                <div class="sidebar-header">
                    <img src="assets/logo.png" alt="Trapped" class="sidebar-logo">
                    <div class="user-profile">
                        <div class="user-avatar">{{ currentUser?.username?.[0]?.toUpperCase() }}</div>
                        <div class="user-details">
                            <div class="user-name">{{ currentUser?.username }}</div>
                            <div v-if="currentUser?.isAdmin" class="user-role">Administrateur</div>
                        </div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <button
                        @click="activeSection = 'new-game'; closeMobileSidebar()"
                        :class="['nav-item', { active: activeSection === 'new-game' }]">
                        <span class="nav-icon">ğŸ®</span>
                        <span class="nav-label">Nouvelle partie</span>
                    </button>
                    <button
                        @click="activeSection = 'saved-games'; closeMobileSidebar()"
                        :class="['nav-item', { active: activeSection === 'saved-games' }]">
                        <span class="nav-icon">ğŸ’¾</span>
                        <span class="nav-label">Parties sauvegardÃ©es</span>
                        <span v-if="savedGames.length > 0" class="nav-badge">{{ savedGames.length }}</span>
                    </button>
                    <button
                        @click="toggleHelp(); closeMobileSidebar()"
                        class="nav-item">
                        <span class="nav-icon">â“</span>
                        <span class="nav-label">Aide</span>
                    </button>
                    <button
                        v-if="currentUser?.isAdmin"
                        @click="activeSection = 'admin'; closeMobileSidebar()"
                        :class="['nav-item', { active: activeSection === 'admin' }]">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-label">Administration</span>
                    </button>
                </nav>

                <div class="sidebar-footer">
                    <button @click="logout" class="btn-logout-sidebar">
                        <span class="nav-icon">ğŸšª</span>
                        <span class="nav-label">DÃ©connexion</span>
                    </button>
                </div>
            </div>

            <!-- Contenu principal -->
            <div class="main-content">
                <!-- Section Nouvelle partie -->
                <div v-if="activeSection === 'new-game'" class="content-section">
                    <h1 class="section-title">ğŸ® Nouvelle partie</h1>

                    <div class="game-settings-card">
                        <h2>âš™ï¸ Configuration</h2>
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>DifficultÃ©</label>
                                <select v-model="difficulty" class="select-modern">
                                    <option value="easy">Facile (25 points)</option>
                                    <option value="normal">Normale (20 points)</option>
                                    <option value="hard">Difficile (15 points)</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label class="checkbox-modern">
                                    <input type="checkbox" v-model="freeRoomsEnabled">
                                    <span>PiÃ¨ces gratuites (10% chance)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="players-card">
                        <h2>ğŸ‘¥ Joueurs ({{ players.length }}/12)</h2>

                        <div class="player-form-modern">
                            <input
                                v-model="newPlayerName"
                                @keyup.enter="openAvatarPicker"
                                type="text"
                                placeholder="Nom du joueur"
                                maxlength="20"
                                class="input-modern"
                            >
                            <button @click="openAvatarPicker" class="btn-avatar-modern" type="button">
                                <img v-if="tempAvatar" :src="`avatars/${tempGender}/${tempAvatar}`" class="avatar-preview-modern">
                                <span v-else>Choisir avatar</span>
                            </button>
                            <button @click="addPlayer" :disabled="!newPlayerName.trim() || !tempAvatar" class="btn-add-modern">
                                Ajouter
                            </button>
                        </div>

                        <div class="players-grid" v-if="players.length > 0">
                            <div v-for="(player, index) in players" :key="index" class="player-card-modern">
                                <img :src="`avatars/${player.gender}/${player.avatar}`" class="player-avatar-modern" :alt="player.name">
                                <div class="player-name-modern">{{ player.name }}</div>
                                <button @click="removePlayer(index)" class="btn-remove-modern">Ã—</button>
                            </div>
                        </div>

                        <div v-else class="empty-state">
                            <div class="empty-icon">ğŸ‘¤</div>
                            <p>Aucun joueur ajoutÃ©</p>
                            <p class="empty-hint">Ajoutez au moins 3 joueurs pour commencer</p>
                        </div>
                    </div>

                    <button
                        @click="startGame"
                        :disabled="players.length < 3"
                        class="btn-start-modern"
                    >
                        ğŸš€ Lancer la partie
                    </button>

                    <p v-if="error" class="error-modern">{{ error }}</p>
                </div>

                <!-- Section Parties sauvegardÃ©es -->
                <div v-if="activeSection === 'saved-games'" class="content-section">
                    <h1 class="section-title">ğŸ’¾ Parties sauvegardÃ©es</h1>

                    <div v-if="savedGames.length === 0" class="empty-state">
                        <div class="empty-icon">ğŸ²</div>
                        <p>Aucune partie sauvegardÃ©e</p>
                        <p class="empty-hint">Vos parties apparaÃ®tront ici</p>
                    </div>

                    <div v-else class="saved-games-grid">
                        <div v-for="game in savedGames" :key="game.id" class="saved-game-card">
                            <div class="saved-game-header-modern">
                                <div class="saved-game-date-modern">{{ formatDate(game.createdAt) }}</div>
                                <span :class="['saved-game-status-modern', game.status]">
                                    {{ game.status === 'playing' ? 'â–¶ï¸ En cours' : 'âœ… TerminÃ©e' }}
                                </span>
                            </div>
                            <div class="saved-game-info-modern">
                                <div class="info-item">
                                    <span class="info-label">Tour</span>
                                    <span class="info-value">{{ game.currentTurn }}/15</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Joueurs</span>
                                    <span class="info-value">{{ game.playerCount }}</span>
                                </div>
                            </div>
                            <div class="saved-game-players-modern">{{ game.playerNames }}</div>
                            <div class="saved-game-actions">
                                <button @click="loadGame(game.id)" class="btn-load-modern">
                                    Reprendre
                                </button>
                                <button @click.stop="deleteGame(game.id)" class="btn-delete-modern" title="Supprimer">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Administration -->
                <div v-if="activeSection === 'admin' && currentUser?.isAdmin" class="content-section">
                    <h1 class="section-title">âš™ï¸ Administration</h1>

                    <div class="admin-card">
                        <h2>ğŸ“Š Statistiques</h2>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">{{ savedGames.length }}</div>
                                <div class="stat-label">Parties totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ savedGames.filter(g => g.status === 'playing').length }}</div>
                                <div class="stat-label">En cours</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ savedGames.filter(g => g.status === 'finished').length }}</div>
                                <div class="stat-label">TerminÃ©es</div>
                            </div>
                        </div>
                    </div>

                    <div class="admin-card">
                        <h2>ğŸ‘¤ Profil administrateur</h2>
                        <div class="admin-info">
                            <p><strong>Email:</strong> {{ currentUser?.email }}</p>
                            <p><strong>Nom:</strong> {{ currentUser?.username }}</p>
                            <p><strong>RÃ´le:</strong> Administrateur</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ã‰cran de jeu -->
        <div v-if="screen === 'game'" class="game-screen">
            <game-board
                :game="game"
                :remaining-time="remainingTime"
                @open-door="openDoor"
                @choose-door="chooseDoor"
                @free-player="freePlayer"
                @stay-in-room="stayInRoom"
                @give-up="giveUp"
                @go-home="goHome"
                @toggle-help="toggleHelp"
            ></game-board>
        </div>

        <!-- Ã‰cran de fin -->
        <div v-if="screen === 'end'" class="end-screen">
            <h1>ğŸ® Partie terminÃ©e</h1>

            <div v-if="endData.reason === 'victory'" class="winners">
                <h2>ğŸ Gagnants !</h2>
                <table class="winners-table">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Nom</th>
                            <th>Points</th>
                            <th>Bonheur</th>
                            <th>Max bonheur</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(winner, index) in endData.winners" :key="winner.id">
                            <td class="rank">{{ index + 1 }}</td>
                            <td class="name">{{ winner.name }}</td>
                            <td class="points">{{ winner.points }}</td>
                            <td class="happiness">{{ winner.happiness || 0 }}</td>
                            <td class="max-happiness">{{ winner.maxHappiness || 0 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-else class="defeat">
                <h2>ğŸ’€ DÃ©faite</h2>
                <p v-if="endData.reason === 'timeout'">Le temps est Ã©coulÃ© (15 tours)</p>
                <p v-if="endData.reason === 'all_dead'">Tous les joueurs sont morts</p>
            </div>

            <div v-if="endData.survivors && endData.survivors.length > 0" class="survivors">
                <h3>Survivants</h3>
                <div v-for="survivor in endData.survivors" :key="survivor.id">
                    {{ survivor.name }} - {{ survivor.points }} points - Max bonheur: {{ survivor.maxHappiness || 0 }}
                </div>
            </div>

            <div v-if="endData.dead && endData.dead.length > 0" class="dead">
                <h3>ğŸ’€ Morts</h3>
                <div v-for="dead in endData.dead" :key="dead.id" class="dead-item">
                    {{ dead.name }} - Max bonheur: {{ dead.maxHappiness || 0 }}
                </div>
            </div>

            <div class="end-screen-actions">
                <button @click="resetGame" class="btn-reset">Nouvelle partie</button>
                <button @click="goHome(true)" class="btn-home-end">Menu principal</button>
            </div>
        </div>

        <!-- Modale de confirmation -->
        <div v-if="showModal" class="modal-overlay" @click="cancelModal">
            <div class="modal-content" @click.stop>
                <h2>{{ modalData.title }}</h2>
                <p>{{ modalData.message }}</p>
                <div class="modal-actions">
                    <button @click="cancelModal" class="btn-modal-cancel">{{ modalData.cancelText }} <span class="keyboard-hint">Esc</span></button>
                    <button @click="confirmModal" class="btn-modal-confirm">{{ modalData.confirmText }} <span class="keyboard-hint">â†µ</span></button>
                </div>
            </div>
        </div>

        <!-- Modale d'aide -->
        <div v-if="showHelp" class="modal-overlay" @click="toggleHelp">
            <div class="modal-content modal-help" @click.stop>
                <button @click="toggleHelp" class="btn-close-modal" title="Fermer (Esc)">Ã—</button>
                <h2>ğŸšª Comment jouer Ã  Trapped</h2>

                <div class="help-section">
                    <h3>ğŸ¯ Objectif</h3>
                    <p><strong>Jeu collaboratif :</strong> Faire sortir un maximum de joueurs ! Tous les joueurs vivants doivent atteindre la salle de sortie avec au moins 1 point. En cas d'Ã©galitÃ©, le joueur avec le plus de bonheur gagne.</p>
                </div>

                <div class="help-section">
                    <h3>âš™ï¸ DÃ©roulement</h3>
                    <ul>
                        <li><strong>Tour par tour :</strong> Vous avez 2 minutes par tour pour faire votre choix</li>
                        <li><strong>15 tours maximum</strong> pour sortir, sinon c'est perdu pour tout le monde</li>
                        <li>Choisissez une porte ou restez dans votre salle actuelle</li>
                        <li>Tous les joueurs jouent simultanÃ©ment Ã  chaque tour</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸšª Les portes et leur capacitÃ©</h3>
                    <ul>
                        <li><strong>Portes fermÃ©es :</strong> CoÃ»tent 1 point Ã  ouvrir (premier joueur Ã  choisir)</li>
                        <li><strong>Portes ouvertes :</strong> Gratuites pour les suivants</li>
                        <li><strong>CapacitÃ© (le chiffre) :</strong> Indique combien de joueurs peuvent franchir cette porte <strong>pendant le tour actuel</strong></li>
                        <li>Si le nombre maximum de joueurs est atteint, la porte est pleine et plus personne ne peut la choisir</li>
                        <li><strong>Bonheur :</strong> Chaque porte donne ou enlÃ¨ve du bonheur (invisible jusqu'Ã  l'ouverture)</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ’° Points et salles</h3>
                    <ul>
                        <li>Chaque salle coÃ»te des points pour y entrer (sauf la sortie)</li>
                        <li>Le coÃ»t est cachÃ© jusqu'Ã  ce qu'un joueur visite la salle</li>
                        <li><strong>0 point = vous Ãªtes mort !</strong></li>
                        <li>Certaines salles peuvent Ãªtre gratuites (si activÃ©)</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ˜Š Le bonheur</h3>
                    <p>Si plusieurs joueurs atteignent la sortie, celui avec le <strong>plus de bonheur total</strong> gagne. Le bonheur est influencÃ© par les portes que vous franchissez.</p>
                </div>

                <div class="help-section">
                    <h3>ğŸ® Actions possibles</h3>
                    <ul>
                        <li><strong>Choisir une porte :</strong> Cliquez sur votre badge puis sur une flÃ¨che directionnelle</li>
                        <li><strong>Rester ici :</strong> Cliquez sur votre badge puis sur le bouton central</li>
                        <li><strong>LibÃ©rer un joueur :</strong> Si vous Ãªtes Ã  la sortie, vous pouvez abandonner pour sauver quelqu'un de bloquÃ©</li>
                        <li><strong>Abandonner :</strong> Si quelqu'un est dÃ©jÃ  sorti, vous pouvez abandonner</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“Š Niveaux de difficultÃ©</h3>
                    <ul>
                        <li><strong>Facile :</strong> 25 points de dÃ©part</li>
                        <li><strong>Normal :</strong> 20 points de dÃ©part</li>
                        <li><strong>Difficile :</strong> 15 points de dÃ©part</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ Conditions de victoire</h3>
                    <ul>
                        <li>âœ… Tous les joueurs vivants atteignent la sortie</li>
                        <li>âŒ DÃ©faite si le temps expire (15 tours) ou si tous les joueurs meurent</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modale de sÃ©lection d'avatar -->
        <div v-if="showAvatarPicker" class="modal-overlay" @click="showAvatarPicker = false">
            <div class="modal-content modal-avatar-picker" @click.stop>
                <button @click="showAvatarPicker = false" class="btn-close-modal" title="Fermer (Esc)">Ã—</button>
                <h2>Choisis ton avatar</h2>

                <div class="avatar-type-selector">
                    <button
                        @click="avatarPickerType = 'adult'"
                        :class="['btn-avatar-type', {active: avatarPickerType === 'adult'}]">
                        ğŸ§‘ Adulte
                    </button>
                    <button
                        @click="avatarPickerType = 'child'"
                        :class="['btn-avatar-type', {active: avatarPickerType === 'child'}]">
                        ğŸ‘¶ Enfant
                    </button>
                </div>

                <div class="avatar-gender-selector">
                    <button
                        @click="avatarPickerGender = 'male'"
                        :class="['btn-gender', {active: avatarPickerGender === 'male'}]">
                        ğŸ‘¨ {{ avatarPickerType === 'child' ? 'GarÃ§on' : 'Homme' }}
                    </button>
                    <button
                        @click="avatarPickerGender = 'female'"
                        :class="['btn-gender', {active: avatarPickerGender === 'female'}]">
                        ğŸ‘© {{ avatarPickerType === 'child' ? 'Fille' : 'Femme' }}
                    </button>
                </div>

                <div class="avatar-grid">
                    <div
                        v-for="i in getAvatarCount(avatarPickerGender, avatarPickerType)"
                        :key="i"
                        @click="selectAvatar(avatarPickerGender, i, avatarPickerType)"
                        class="avatar-option"
                        :class="{selected: isAvatarUsed(avatarPickerGender, i, avatarPickerType)}">
                        <img :src="`avatars/${avatarPickerGender}/${(avatarPickerType === 'child' ? 'children' : avatarPickerGender)}_${String(i).padStart(2, '0')}.png`" :alt="`Avatar ${i}`">
                        <span v-if="isAvatarUsed(avatarPickerGender, i, avatarPickerType)" class="avatar-used-badge">âœ“</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup de perte de points -->
        <div v-if="showPointsLossPopup" class="points-loss-overlay">
            <div class="points-loss-popup">
                <h2>Fin du tour {{ pointsLossData?.turn }}</h2>
                <div class="players-points-grid">
                    <div v-for="player in pointsLossData?.players" :key="player.id" class="player-points-card">
                        <div class="player-avatar">
                            <span v-if="player.finalStatus === 'dead'" class="player-status-icon">ğŸ’€</span>
                            <span v-else-if="player.finalStatus === 'winner'" class="player-status-icon">ğŸ</span>
                            <img v-else :src="`avatars/${player.gender}/${player.avatar}`" class="player-avatar-img" :alt="player.name">
                        </div>
                        <div class="player-name">{{ player.name }}</div>
                        <div class="player-points-value">
                            <span class="points-number">{{ player.animatedPoints }}</span>
                            <span class="points-label">pts</span>
                            <span v-if="player.showLoss && player.pointsLost > 0" class="points-lost-indicator">
                                -{{ player.pointsLost }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
